# GitHub Actions Pipeline â€” Windowsâ€‘only, latest toolchain
name: CI / Windows Build & Bundle

on:
  push:
    branches: [main, dev]
    tags: ['v*.*.*']            # e.g. v1.2.3
  pull_request:
    branches: [main, dev]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-windows:
    runs-on: windows-latest        # GitHubâ€™s newest Windows image
    timeout-minutes: 60

    env:
      RUST_BACKTRACE: full
      FRONTEND_DIR: src            # ðŸ‘‰ SolidJS root folder

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. Rust toolchain â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. Cargo cache â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            ${{ github.workspace }}/src-tauri -> target

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. Node 22 (no builtâ€‘in pnpm cache) â”€â”€
      - uses: actions/setup-node@v4
        with:
          node-version: 22

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5. Enable pnpm 9 via Corepack â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Enable pnpm 9
        run: |
          corepack enable
          corepack prepare pnpm@9 --activate
          pnpm --version
        shell: pwsh

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6. Cache pnpm store â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ env.LOCALAPPDATA }}\\pnpm-store
          key: windows-pnpm-${{ hashFiles('src/pnpm-lock.yaml') }}
          restore-keys: windows-pnpm-

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7. JS dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install JS dependencies
        run: pnpm --dir $env:FRONTEND_DIR install --frozen-lockfile
        shell: pwsh

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 8. Build frontend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build frontend
        run: pnpm --dir $env:FRONTEND_DIR run build
        shell: pwsh

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 9. Tauri bundle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Build Windows bundle with Tauri
        run: cargo tauri build --ci --workspace --target x86_64-pc-windows-msvc
        shell: pwsh

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 10. Upload artifacts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/upload-artifact@v4
        with:
          name: windows-bundles
          path: |
            src-tauri/target/release/bundle/windows/**/*.msi
            src-tauri/target/release/bundle/windows/**/*.exe
          if-no-files-found: error
          retention-days: 30

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 11. (Optional) Sign binaries â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Uncomment when you have WINDOWS_CERT & WINDOWS_CERT_PASSWORD secrets
      # - name: Sign Windows binaries
      #   if: env.WINDOWS_CERT && env.WINDOWS_CERT_PASSWORD
      #   shell: powershell
      #   run: |
      #     $certPath = "$env:TEMP\\windows.pfx"
      #     [IO.File]::WriteAllBytes($certPath, [Convert]::FromBase64String($env:WINDOWS_CERT))
      #     signtool sign /f $certPath /p $env:WINDOWS_CERT_PASSWORD /tr http://timestamp.digicert.com /td sha256 src-tauri/target/release/bundle/windows\*.*
